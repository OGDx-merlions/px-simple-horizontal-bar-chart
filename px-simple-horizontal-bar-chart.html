<link rel="import" href="../polymer/polymer.html"/>
<link rel="import" href="/bower_components/px-simple-chart-common-behavior/px-simple-chart-common-behavior.html" />
<!--
A simple bar chart that visualizes series data.

##### Usage

    <px-simple-bar-chart chart-data="[1,2,3]">
    </px-simple-bar-chart>

@element px-simple-horizontal-bar-chart
@blurb Predix Experience Simple Horizontal Bar Chart
@homepage index.html
@demo demo.html
-->
<dom-module id="px-simple-horizontal-bar-chart">
    <script type="text/javascript" src="../d3/d3.js"></script>
    <link rel="import" type="css" href="css/px-simple-horizontal-bar-chart.css"/>
    <template>
        <svg class="px-simple-horizontal-bar-chart-svg"></svg>
    </template>
</dom-module>
<script>

    var defaultColors = ['#5da5da', '#faa43a', '#60bd68', '#f17cb0', '#b2912f',
        '#b276b2', '#decf3f', '#f15854', '#4d4d4d'];
    var defaultChartData = [ 29, 20, 15, 18, 8, 10 ];
    var defaultChartLabels = ['Bar One', 'Bar Two', 'Bar Three', 'Bar Four',
        'Bar Five', 'Bar Six'];

    var legendBox = 12;
    var legendMargin = 5;
    var legendText = 115;
    var legendPadding = 19;
    var legendColumnWidth = legendBox + legendMargin + legendText;
    var legendItemHeight = legendMargin + legendBox;
    var legendMarginTop = 8;
    var barPadding = 2;

    Polymer({

        is: 'px-simple-horizontal-bar-chart',

        behaviors: [pxSimpleChartCommonBehavior],

        /**
         * Properties block, expose attribute values to the DOM via 'reflect'
         *
         * @property properties
         * @type Object
         */
        properties: {

            /**
            * chartData
            *
            * Format: [ 29, 20, 15, 18, 8, 10 ]
            */
            chartData: {
                type: Array,
                observer: '_drawChart',
                value: function() {
                    return defaultChartData;
                }
            },

            /**
            * legendLabels
            *
            * Format: Array
            */
            legendLabels: {
                type: Array,
                observer: '_drawChart',
                value: function() {
                    return defaultChartLabels;
                }
            },

            /**
            * colors
            *
            * Format: Array
            */
            colors: {
                type: Array,
                observer: '_drawChart',
                value: function() {
                    return defaultColors;
                }
            },

            /**
            * barLabels
            *
            * Format: String
            * Default: "percentage"
            * Two options: "percentage" or "values"
            */
            barLabels: {
                type: String,
                observer: '_drawChart',
                value: 'percentage'
            }

        },

        _drawChartDebounced: function() {
            if(this.chartData && this.chartData.length > 0 && this.svg) {
                // clear the svg element
                this._clearSVG(this.svg);
                // _setDimensions sets this.widthValue and this.heightValue
                this._setDimensions();
                this._setSizes();
                this._drawSVG();
                this._setScales();
                this._drawBars();
                this._drawLeftLine();
                this._drawLegend();
                // add css class to svg elements using method from pxD3Util
                this._addStyleScope(this.svg);
            } else {
                var that = this;
                var timeout = setTimeout(function(){
                    that._drawChartDebounced();
                }, 100);
            }
        },

        _setSizes: function() {
            this.chartWidth = this.widthValue - this._getBarLabelWidth();
            var availableHeight = this.heightValue - this._getLegendHeight()
            this.barHeight = Math.round(availableHeight / this.chartData.length) - barPadding;
            this.chartHeight = (this.barHeight + barPadding) * (this.chartData.length) - barPadding;
        },

        // TODO: write this function
        _getBarLabelWidth: function() {
            return 50;
        },

        _drawSVG: function() {
            this.svg
                .attr('width', this.widthValue)
                .attr('height', this.heightValue);
        },

        _setScales: function() {
            // no yscale necessary
            this.xScale = d3.scale
                .linear()
                .domain([0, d3.max(this.chartData)])
                .range([0, this.chartWidth]);
        },


        _getColor: function(index) {
            if(index >= 0 && index < this.colors.length) {
                return this.colors[index];
            } else {
                // recurse and loop through color list
                return this._getColor(Math.abs(this.colors.length - index));
            };
        },

        /**
         * _getLegendColumns() calculates the number of columns necessary
         * depends on variables legendPadding, legendColumnWidth,
         * this.heightValue, this.widthValue
         *
         * @return {Number} numColumns
        */
        _getLegendColumns() {
            var maxColumns = (this.widthValue - legendPadding) / legendColumnWidth;
            if( (this.chartData.length / maxColumns) >= 1) {
                return maxColumns;
            } else {
                return this.chartData.length % maxColumns;
            };
        },

        _getMaxItemsInColumn: function() {
            return Math.ceil(this.chartData.length / this._getLegendColumns());
        },

        /**
         * _getLegendHeight() calculates the necessary height of legend
         *
         * @param {Object} chartData
         * @return {Number} numColumns
        */
        _getLegendHeight: function() {
            return (this._getMaxItemsInColumn() * legendItemHeight) + legendMarginTop;
        },

        _drawLegendBox: function(x, y, color) {
            return this.svg
                .append("rect")
                .attr("class", "legend-box")
                .attr("x", x)
                .attr("y", y)
                .attr("width", legendBox)
                .attr("height", legendBox)
                .attr("fill", color);
        },

        _drawLegendLabel: function(x, y, labelText) {
            return this.svg
                .append("text")
                .attr("class", "legend-text")
                .attr("x", x + 10)
                .attr("y", y + 11)
                .text(labelText);
        },

        _drawLegendItem: function(x, y, color, labelText) {
            this._drawLegendBox(x, y, color);
            this._drawLegendLabel(x + legendMargin, y, labelText);
        },

        // TODO: return the text, shortened to fit in the width and add '...' to
        // the end
        _shortenText(text, targetWidth) {
            var width = this._calculateTextWidth(text, "legend-text");
            if(width <= targetWidth) {
                return text;
            } else {
                return this._shortenText(
                    text.substring(0, text.length - 4) + '...',
                    targetWidth
                );
            }

        },

        _drawLegend: function() {
            var dataLength = this.chartData.length;
            var i;
            for(i=0;i<dataLength;i++) {
                var labelText = this.legendLabels[i];
                var textWidth = this._calculateTextWidth(labelText, "legend-text");
                var targetWidth = legendText - 10;
                if(textWidth > targetWidth) {
                    labelText = this._shortenText(labelText, targetWidth);
                    console.log('new label text', labelText);
                };
                var color = this._getColor(i);
                var maxItemsInColumn = this._getMaxItemsInColumn();
                var columnNumber = Math.floor(i/maxItemsInColumn);
                var x = columnNumber * legendColumnWidth;
                var columnTop = legendItemHeight * maxItemsInColumn * columnNumber;
                var y = (i * legendItemHeight) + this.chartHeight - columnTop + legendMarginTop;
                //console.log(columnNumber, x, y, color, labelText)
                this._drawLegendItem(x, y, color, labelText);
            };
        },

        _drawBar: function(x, y, width, height, i, color) {
            this.svg
                .append("rect")
                .attr("class", "bar")
                .attr("x", x)
                .attr("y", y)
                .attr("width", width)
                .attr("height", height)
                .attr("fill", i);
        },

        _calculateLabelCenterOffset: function(labelText) {
            var height = this._calculateTextHeight(labelText);
            var diff = Math.abs(this.barHeight - height);
            var offset = (diff / 2) - barPadding + height;
            return Math.round(offset - offset * 0.25);
        },

        _drawBarLabel: function(x, y, labelText) {
            // use common function _calculateTextWidth to calc label width
            var textWidth = this._calculateTextWidth(labelText);
            this.svg
                .append("text")
                .attr("class", "bar-label")
                .attr("x", this.widthValue - textWidth - 10 )
                .attr("y", y + this._calculateLabelCenterOffset(labelText))
                .attr("width", textWidth)
                .text(labelText);
        },

        _sum: function(arr) {
            return arr.reduce(function(previousValue, currentValue) {
                return previousValue + currentValue;
            });
        },

        _getPercent: function(value) {
            return Math.round(value / this._sum(this.chartData) * 100);
        },

        _drawBars: function() {
            // loop through the chartData and draw a bar for each value
            var length = this.chartData.length, i = 0, value, labelText, barWidth, y, x, color;
            for(i;i<length;i++) {
                value = this.chartData[i];
                textLabel = this._getPercent(value);
                barWidth = Math.floor(this.xScale(value));
                x = 0;
                y = i * (this.barHeight + barPadding);
                color = this._getColor(i);
                this._drawBar(x, y, barWidth, this.barHeight, color);
                this._drawBarLabel(x, y, String(value) + "%");
            };
        },

        _drawLeftLine: function() {
            this.svg
                .append("line")
                .attr("class","bar-chart-bottom-line")
                .attr("x1", 0)
                .attr("y1", 0)
                .attr("x2", 0)
                .attr("y2", this.chartHeight);
        }


    });
</script>
